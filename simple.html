<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Language Learning App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Left Navigation Panel -->
        <nav class="w-64 lg:w-1/4 bg-white p-4 overflow-y-auto shadow-lg flex-shrink-0">
            <h2 class="text-2xl font-bold text-purple-700 mb-5 border-b pb-2">Word List</h2>
            <ul id="word-navigation-list" class="space-y-1">
                <li class="text-gray-500">Loading course content...</li>
            </ul>
            <button id="practice-button" onclick="startPractice()"
                class="mt-6 w-full px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors shadow-md"
                style="display: none;">
                Practice All Words
            </button>
        </nav>

        <!-- Right Content Panel -->
        <main class="flex-grow p-6 overflow-y-auto bg-purple-50">
            <div id="view-container">
                <div class="text-center py-20">
                    <h1 class="text-3xl font-bold text-purple-700 mb-4">Loading...</h1>
                    <p class="text-lg text-gray-600">Please wait while we load your course content.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initDB, executeQuery } from './js/dbService.js';

        let db = null;
        let allWords = [];
        let modules = [];

        async function initializeApp() {
            console.log('Initializing simple app...');

            try {
                // Initialize database
                console.log('Loading database...');
                const SQL = await window.initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
                });

                const dbResponse = await fetch('100_EN_real_estate.sqlite3');
                if (!dbResponse.ok) {
                    throw new Error(`Failed to fetch database: ${dbResponse.statusText}`);
                }
                const dbFileArrayBuffer = await dbResponse.arrayBuffer();
                db = new SQL.Database(new Uint8Array(dbFileArrayBuffer));
                console.log('Database loaded successfully');

                // Load words
                console.log('Loading words...');
                const stmt = db.prepare('SELECT * FROM words ORDER BY module_id, id');
                allWords = [];
                while (stmt.step()) {
                    allWords.push(stmt.getAsObject());
                }
                stmt.free();
                console.log('Loaded', allWords.length, 'words');

                // Extract modules from words
                const moduleMap = new Map();
                allWords.forEach(word => {
                    if (word.module_id && !moduleMap.has(word.module_id)) {
                        moduleMap.set(word.module_id, {
                            id: word.module_id,
                            name: word.module_name || `Module ${word.module_id}`,
                            description: `Module with words`
                        });
                    }
                });
                modules = Array.from(moduleMap.values());
                console.log('Extracted', modules.length, 'modules');

                // Populate navigation
                populateNavigation();

                // Show main view
                showMainView();

                // Show practice button
                document.getElementById('practice-button').style.display = 'block';

            } catch (error) {
                console.error('Initialization failed:', error);
                document.getElementById('view-container').innerHTML = `
                    <div class="text-center py-20">
                        <h1 class="text-3xl font-bold text-red-700 mb-4">Error</h1>
                        <p class="text-lg text-gray-600">Failed to load course content: ${error.message}</p>
                    </div>
                `;
            }
        }

        function populateNavigation() {
            const navList = document.getElementById('word-navigation-list');
            navList.innerHTML = '';

            // Group words by module
            const wordsByModule = {};
            allWords.forEach(word => {
                const moduleId = word.module_id || 'ungrouped';
                if (!wordsByModule[moduleId]) {
                    wordsByModule[moduleId] = [];
                }
                wordsByModule[moduleId].push(word);
            });

            // Create navigation items
            Object.keys(wordsByModule).forEach(moduleId => {
                const module = modules.find(m => m.id == moduleId);
                const moduleName = module ? module.name : `Module ${moduleId}`;

                // Create module header
                const moduleHeader = document.createElement('li');
                moduleHeader.className = 'font-semibold text-purple-600 mt-4 mb-2 border-b border-purple-200 pb-1';
                moduleHeader.textContent = moduleName;
                navList.appendChild(moduleHeader);

                // Create word items for this module
                wordsByModule[moduleId].forEach(word => {
                    const wordItem = document.createElement('li');
                    wordItem.className = 'cursor-pointer p-2 rounded hover:bg-purple-100 transition-colors text-sm';
                    wordItem.textContent = word.term || 'Unknown word';
                    wordItem.addEventListener('click', () => showWordDetail(word));
                    navList.appendChild(wordItem);
                });
            });
        }

        function showMainView() {
            const viewContainer = document.getElementById('view-container');
            const moduleCards = modules.map(module => `
                <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                    <h3 class="text-xl font-semibold text-purple-700 mb-2">${module.name}</h3>
                    <p class="text-gray-600">${module.description}</p>
                </div>
            `).join('');

            viewContainer.innerHTML = `
                <div class="text-center py-20">
                    <h1 class="text-3xl font-bold text-purple-700 mb-4">Language Learning Course</h1>
                    <p class="text-lg text-gray-600 mb-6">Select a word from the navigation panel to begin learning.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8">
                        ${moduleCards}
                    </div>
                </div>
            `;
        }

        function showWordDetail(word) {
            const viewContainer = document.getElementById('view-container');
            viewContainer.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-4xl font-bold text-purple-800 mb-4">${word.term}</h2>
                    <p class="text-2xl text-gray-700 mb-4">${word.translation || 'No translation available'}</p>
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-purple-700">Definition:</h3>
                        <p class="text-gray-700">${word.definition || 'No definition available'}</p>
                    </div>
                    <button onclick="showMainView()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                        Back to Main
                    </button>
                </div>
            `;
        }

        window.startPractice = function () {
            const viewContainer = document.getElementById('view-container');
            viewContainer.innerHTML = `
                <div class="text-center py-20">
                    <h1 class="text-3xl font-bold text-purple-700 mb-4">Practice Mode</h1>
                    <p class="text-lg text-gray-600">Practice with ${allWords.length} words</p>
                    <button onclick="showMainView()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                        Back to Main
                    </button>
                </div>
            `;
        };

        window.showMainView = showMainView;

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>

</html>